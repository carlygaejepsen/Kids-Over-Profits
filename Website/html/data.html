<style>
    .note-controls {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 6px;
        flex-wrap: wrap;
    }

    .note-add-btn {
        background-color: #2563eb;
        color: #ffffff;
        border: none;
        border-radius: 6px;
        padding: 4px 10px;
        font-size: 0.85rem;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .note-add-btn:hover {
        background-color: #1d4ed8;
    }

    .note-controls .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }

    .field-notes {
        width: 100%;
        margin-top: 6px;
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .note-row {
        display: flex;
        align-items: flex-start;
        gap: 8px;
    }

    .note-textarea {
        flex: 1;
        min-height: 72px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        padding: 6px 10px;
        font-size: 0.9rem;
        resize: vertical;
    }

    .remove-note-btn {
        background: none;
        border: none;
        color: #dc2626;
        font-size: 0.85rem;
        cursor: pointer;
        padding: 4px 0;
    }

    .remove-note-btn:hover {
        text-decoration: underline;
    }

</style>
<script>
    (function configureKidsOverProfitsForm() {
        const DEFAULT_THEME_BASE = 'https://kidsoverprofits.org/themes/child';
        const LEGACY_THEME_BASE = 'https://kidsoverprofits.org/wp-content/themes/child';
        const THEME_BASE_PATTERN = /(^\.\.\/(?:wp-content\/)?themes\/)|\/themes\//i;

        function cleanBase(value) {
            if (typeof value !== 'string') {
                return '';
            }

            return value.trim().replace(/\/+$/, '');
        }

        function isValidThemeBase(value) {
            const normalized = cleanBase(value);
            return Boolean(normalized && THEME_BASE_PATTERN.test(normalized));
        }

        function detectThemeBaseFromDataAttribute() {
            try {
                const node = document.querySelector('[data-kop-theme-base]');

                if (node && node.dataset && node.dataset.kopThemeBase) {
                    return node.dataset.kopThemeBase.trim();
                }
            } catch (error) {
                console.warn('Kids Over Profits: unable to read theme base from dataset.', error);
            }

            return '';
        }

        function detectThemeBaseFromMeta() {
            try {
                const meta = document.querySelector('meta[name="kids-over-profits-theme-base"]');

                if (meta && meta.content) {
                    return meta.content.trim();
                }
            } catch (error) {
                console.warn('Kids Over Profits: unable to read meta theme base.', error);
            }

            return '';
        }

        function expandThemeBaseVariants(base) {
            const normalized = cleanBase(base);

            if (!normalized) {
                return [];
            }

            const variants = [normalized];
            const wpSegment = '/wp-content/themes/';
            const altSegment = '/themes/';

            if (normalized.includes(wpSegment)) {
                variants.push(normalized.replace(wpSegment, altSegment));
            } else if (normalized.includes(altSegment)) {
                variants.push(normalized.replace(altSegment, wpSegment));
            }

            const unique = new Set();

            return variants
                .map(cleanBase)
                .filter((value) => {
                    if (!value || unique.has(value)) {
                        return false;
                    }

                    unique.add(value);
                    return true;
                });
        }

        function detectThemeBaseFromDomAssets() {
            const selectors = ['link[href*="/wp-content/themes/" i]', 'script[src*="/wp-content/themes/" i]'];
            const matches = [];

            try {
                for (const selector of selectors) {
                    const elements = document.querySelectorAll(selector);

                    for (const element of elements) {
                        const url = element.href || element.src;

                        if (!url) {
                            continue;
                        }

                        const match = url.match(/^(https?:\/\/[^?#]+\/wp-content\/themes\/[^\/?#]+)/i);

                        if (match) {
                            matches.push(match[1]);
                        }
                    }
                }
            } catch (error) {
                console.warn('Kids Over Profits: unable to detect theme base from DOM.', error);
            }

            if (!matches.length) {
                return '';
            }

            matches.sort((a, b) => {
                const aIsChild = /child/i.test(a);
                const bIsChild = /child/i.test(b);

                if (aIsChild && !bIsChild) {
                    return -1;
                }

                if (!aIsChild && bIsChild) {
                    return 1;
                }

                return a.length - b.length;
            });

            return matches[0];
        }

        function detectThemeBaseFromLocation() {
            try {
                const { origin, pathname } = window.location;
                const normalizedPath = pathname.replace(/\/+$/, '');
                const htmlSegmentIndex = normalizedPath.lastIndexOf('/html/');

                if (htmlSegmentIndex !== -1) {
                    const basePath = normalizedPath.substring(0, htmlSegmentIndex);
                    return (origin + basePath).replace(/\/$/, '');
                }
            } catch (error) {
                console.warn('Kids Over Profits: unable to auto-detect theme base from location.', error);
            }

            return '';
        }

        function normalizeBase(base, fallback) {
            return cleanBase(base || fallback);
        }

        function joinUrl(base, relativePath) {
            if (!relativePath) {
                return relativePath;
            }

            if (/^(?:https?:)?\/\//i.test(relativePath) || relativePath.startsWith('/')) {
                return relativePath;
            }

            const normalizedBase = cleanBase(base);

            if (!normalizedBase) {
                return relativePath;
            }

            return normalizedBase + '/' + relativePath.replace(/^\//, '');
        }

        const detectedThemeBase = [
            window.KOP_THEME_BASE,
            detectThemeBaseFromDataAttribute(),
            detectThemeBaseFromMeta(),
            detectThemeBaseFromDomAssets(),
            detectThemeBaseFromLocation()
        ].find((value) => typeof value === 'string' && value.length > 0) || '';

        const isLikelyWordPress =
            Boolean(window.KOP_IS_WORDPRESS) ||
            (typeof document !== 'undefined' &&
                document.body &&
                /\bwp-/.test(document.body.className)) ||
            Boolean(detectedThemeBase && /\/wp-content\/themes\//i.test(detectedThemeBase));

        if (isLikelyWordPress) {
            window.KOP_IS_WORDPRESS = true;
        }

        if (!window.KOP_THEME_BASE && detectedThemeBase) {
            window.KOP_THEME_BASE = detectedThemeBase;
        }

        if (!window.KOP_LOCAL_BASE && detectedThemeBase) {
            window.KOP_LOCAL_BASE = detectedThemeBase;
        }

        const resolvedThemeBase = normalizeBase(window.KOP_THEME_BASE, detectedThemeBase || DEFAULT_THEME_BASE);
        const resolvedLocalBase = normalizeBase(window.KOP_LOCAL_BASE, detectedThemeBase || '../themes/child');
        const locationThemeBase = (() => {
            try {
                if (window.location && window.location.origin) {
                    return cleanBase(window.location.origin + '/themes/child');
                }
            } catch (error) {
                console.warn('Kids Over Profits: unable to derive theme base from location origin.', error);
            }

            return '';
        })();

        window.KOP_DETECTED_THEME_BASE = detectedThemeBase;
        window.KOP_RESOLVED_THEME_BASE = resolvedThemeBase;
        window.KOP_RESOLVED_LOCAL_BASE = resolvedLocalBase;
        window.KOP_THEME_BASE = window.KOP_THEME_BASE || resolvedThemeBase;
        window.KOP_LOCAL_BASE = window.KOP_LOCAL_BASE || resolvedLocalBase;

        const candidateThemeBases = [
            window.KOP_THEME_BASE,
            window.KOP_LOCAL_BASE,
            detectedThemeBase,
            resolvedThemeBase,
            resolvedLocalBase,
            DEFAULT_THEME_BASE,
            LEGACY_THEME_BASE,
            locationThemeBase,
            '../themes/child',
            '../wp-content/themes/child'
        ];

        const expandedCandidates = candidateThemeBases
            .map((base) => expandThemeBaseVariants(base))
            .reduce((all, variants) => all.concat(variants), []);

        const uniqueThemeBases = (() => {
            const seen = new Set();
            const combined = candidateThemeBases.concat(expandedCandidates);
            const result = [];

            combined.forEach((value) => {
                const normalized = cleanBase(value);

                if (!normalized || !isValidThemeBase(normalized) || seen.has(normalized)) {
                    return;
                }

                seen.add(normalized);
                result.push(normalized);
            });

            return result;
        })();

        if (!Array.isArray(window.KOP_THEME_BASES)) {
            window.KOP_THEME_BASES = [];
        }

        const preservedThemeBases = window.KOP_THEME_BASES
            .map(cleanBase)
            .filter((value) => isValidThemeBase(value) && !uniqueThemeBases.includes(value));

        window.KOP_THEME_BASES = uniqueThemeBases.concat(preservedThemeBases);

        if (typeof window.KOP_EXPAND_THEME_BASE !== 'function') {
            window.KOP_EXPAND_THEME_BASE = expandThemeBaseVariants;
        }

        if (typeof window.KOP_IS_VALID_THEME_BASE !== 'function') {
            window.KOP_IS_VALID_THEME_BASE = isValidThemeBase;
        }

        const existingConfig = window.KOP_FACILITY_FORM_CONFIG || {};
        const existingEndpoints = existingConfig.endpoints || {};
        const defaultEndpoints = {
            SAVE_PROJECT: joinUrl(resolvedThemeBase, 'api/save-suggestion.php'),
            LOAD_PROJECTS: joinUrl(resolvedThemeBase, 'api/get-master-data.php'),
            AUTOCOMPLETE: joinUrl(resolvedThemeBase, 'api/get-autocomplete.php')
        };

        window.KOP_FACILITY_FORM_CONFIG = Object.assign({}, existingConfig, {
            mode: 'suggestions',
            endpoints: Object.assign({}, defaultEndpoints, existingEndpoints)
        });

        window.FORM_MODE = 'suggestions';
    })();
</script>
<div class="container">
    <div class="admin-header">
        <h1>üìÆ Submit Facility Data Suggestions</h1>
        <p>All changes auto-save to the cloud</p>
    </div>
    <div class="admin-warning admin-warning--info">
        üìÆ <strong>SUGGESTION MODE:</strong> You are submitting suggestions for review. Changes will not go directly to the master database. Click "Submit Suggestion for Review" when done.
    </div>
    <!-- Category Navigation -->
    <div class="category-navigation" id="category-navigation">
        <div class="flex-center mb-20">
            <div class="category-tabs">
                <button class="category-tab active" id="facilities-tab">
                    üè¢ Companies
                </button>
                <button class="category-tab" id="states-tab">
                    üåç Locations
                </button>
            </div>
        </div>
        <!-- Companies Content -->
        <div id="companies-content" class="category-content">
            <div class="content-header">
                <h3>Select an Operator/Company</h3>
                <p>All projects load from cloud storage</p>
            </div>
            <div class="items-list items-container" id="saved-projects-list">
                <div class="text-muted italic">Loading from cloud...</div>
            </div>
        </div>
        <!-- States Content -->
        <div id="states-content" class="category-content d-none">
            <div class="content-header">
                <h3>Location Projects</h3>
                <p>All projects load from cloud storage</p>
            </div>
            <div class="items-list items-container" id="locations-list">
                <div class="text-muted italic">Loading from cloud...</div>
            </div>
        </div>
    </div>
    <!-- Facility Table of Contents -->
    <div class="facility-toc" id="facility-toc">
        <div class="toc-header">
            <h2 class="toc-title">Facilities Overview</h2>
            <button class="toc-toggle" id="toc-toggle-btn">üîé</button>
        </div>
        <div class="toc-content">
            <div class="toc-stats" id="toc-stats">Total: 1 facility</div>
            <div class="facility-list" id="facility-list">
                <!-- Facility items will be populated here -->
            </div>
            <div class="mt-15 d-flex gap-10 flex-center">
                <button class="btn" id="add-facility-main-btn">Add New Facility</button>
                <button class="btn" id="sort-facilities-btn">Sort Alphabetically</button>
            </div>
        </div>
    </div>
    <!-- Facility Navigation -->
    <div class="facility-controls">
        <div class="facility-header">
            <div class="d-flex align-items-center gap-15">
                <strong>Current Facility: <span id="facility-counter">1 of 1</span></strong>
                <span id="current-facility-name" class="text-muted fw-normal"></span>
                <div class="d-flex gap-5">
                    <button class="btn btn--compact d-none" id="prev-facility-btn">‚¨ÖÔ∏è Previous</button>
                    <button class="btn btn--compact d-none" id="next-facility-btn">Next ‚û°Ô∏è</button>
                </div>
            </div>
            <div class="controls">
                <button class="btn" id="add-facility-btn">Add Facility</button>
                <button class="btn d-none" id="remove-facility-btn">Remove Current</button>
                <button class="btn" id="clone-facility-btn">Clone Facility</button>
            </div>
        </div>
    </div>
    <!-- Operator Information Section -->
    <div class="section expanded" id="operator-section">
        <div class="section-header">
            <h2 class="section-title">Operator Information</h2>
            <span class="section-toggle">üîé</span>
        </div>
        <div class="section-content">
            <div class="form-row">
                <div class="form-group">
                    <label for="operator-name">Operator Name</label>
                    <input type="text" id="operator-name" placeholder="Type operator name..." class="input-form" data-autocomplete-category="operator" data-note-scope="operator" data-note-key="name">
                </div>
                <div class="form-group">
                    <label for="operator-current-name">Current Name</label>
                    <input type="text" id="operator-current-name" placeholder="Type current operator name..." class="input-form" data-autocomplete-category="operator" data-note-scope="operator" data-note-key="currentName">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="operator-location">Primary Location</label>
                    <input type="text" id="operator-location" placeholder="e.g., Waynesboro, TN" data-autocomplete-category="location" data-note-scope="operator" data-note-key="location">
                </div>
                <div class="form-group">
                    <label for="operator-headquarters">Headquarters</label>
                    <input type="text" id="operator-headquarters" placeholder="e.g., Nashville, TN" data-autocomplete-category="location" data-note-scope="operator" data-note-key="headquarters">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="operator-founded">Founded</label>
                    <input type="number" id="operator-founded" placeholder="e.g., 1985" inputmode="numeric" data-note-scope="operator" data-note-key="founded">
                </div>
                <div class="form-group">
                    <label for="operator-period">Operating Period</label>
                    <input type="text" id="operator-period" placeholder="e.g., 1985-Present" data-autocomplete-category="operatingperiod" data-note-scope="operator" data-note-key="operatingPeriod">
                </div>
            </div>
            <div class="form-group">
                <label for="operator-status">Status</label>
                <input type="text" id="operator-status" placeholder="Type status (Active, Acquired, Merged, Defunct, etc.)..." class="input-form" data-autocomplete-category="status" data-note-scope="operator" data-note-key="status">
            </div>
            <div class="form-group">
                <label>Parent Companies</label>
                <div class="array-container" data-path="operator.parentCompanies"></div>
            </div>
            <div class="form-group">
                <label>Websites</label>
                <div class="array-container" data-path="operator.websites"></div>
            </div>
            <h3 class="section-heading">Key Staff</h3>
            <div class="form-group">
                <label for="operator-ceo">CEO/President</label>
                <input type="text" id="operator-ceo" placeholder="e.g., John Smith" data-autocomplete-category="human" data-note-scope="operator" data-note-key="keyStaff.ceo">
            </div>
            <div class="form-group">
                <label>Founders</label>
                <div class="array-container" data-path="operator.keyStaff.founders"></div>
            </div>
            <div class="form-group">
                <label>Key Executives</label>
                <div class="array-container" data-path="operator.keyStaff.keyExecutives"></div>
            </div>
            <div class="form-group">
                <label>Investors</label>
                <div class="array-container" data-path="operator.investors"></div>
            </div>
            <div class="form-group">
                <label>Operator Notes</label>
                <div class="array-container" data-path="operator.notes"></div>
            </div>
        </div>
    </div>
    <!-- Identification Section -->
    <div class="section" id="identification-section">
        <div class="section-header">
            <h2 class="section-title">Identification &amp; Names</h2>
            <span class="section-toggle">üîé</span>
        </div>
        <div class="section-content">
            <div class="form-row">
                <div class="form-group">
                    <label>Name</label>
                <input type="text" id="facility-name" placeholder="Type facility name..." class="input-form" data-autocomplete-category="facility" data-note-scope="facility" data-note-key="identification.name">
                </div>
                <div class="form-group">
                    <label>Current Name</label>
                <input type="text" class="facility-field" data-field="identification.currentName" data-autocomplete-category="facility" data-note-scope="facility" data-note-key="identification.currentName">
                </div>
            </div>
            <div class="form-group">
                <label>Current Operator</label>
                <input type="text" class="facility-field" data-field="identification.currentOperator" data-autocomplete-category="operator" data-note-scope="facility" data-note-key="identification.currentOperator">
            </div>
            <div class="form-group">
                <label>Other Names</label>
                <div class="array-container" data-path="identification.otherNames"></div>
            </div>
        </div>
    </div>
    <!-- Location Section -->
    <div class="section" id="location-section">
        <div class="section-header">
            <h2 class="section-title">Location &amp; Address</h2>
            <span class="section-toggle">üîé</span>
        </div>
        <div class="section-content">
            <div class="form-group">
                <label>Location</label>
                <input type="text" class="facility-field" data-field="location" data-autocomplete-category="location" data-note-scope="facility" data-note-key="location">
            </div>
            <div class="form-group">
                <label>Address</label>
                <textarea class="facility-field" data-field="address" rows="3"></textarea>
            </div>
        </div>
    </div>
    <!-- Operations Section -->
    <div class="section" id="operations-section">
        <div class="section-header">
            <h2 class="section-title">Facility Operations</h2>
            <span class="section-toggle">üîé</span>
        </div>
        <div class="section-content">
            <div class="form-group">
                <label>Other Operators</label>
                <div class="array-container" data-path="otherOperators"></div>
            </div>
            <h3 class="section-heading section-heading--spaced">Facility Operating Dates</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Facility Opened (Year)</label>
                    <input type="number" class="facility-field" data-field="operatingPeriod.startYear" placeholder="e.g., 1985" data-note-scope="facility" data-note-key="operatingPeriod.startYear">
                </div>
                <div class="form-group">
                    <label>Facility Closed (Year)</label>
                    <input type="number" class="facility-field" data-field="operatingPeriod.endYear" placeholder="Leave blank if still open" data-note-scope="facility" data-note-key="operatingPeriod.endYear">
                </div>
            </div>
                <div class="form-group">
                    <label>Current Status</label>
                    <input type="text" class="facility-field input-form" data-field="operatingPeriod.status" placeholder="Type status (Open, Closed, Transferred, etc.)..." data-autocomplete-category="status" data-note-scope="facility" data-note-key="operatingPeriod.status">
                </div>
            <div class="form-group">
                <label>Years of Operation</label>
                <input type="text" class="facility-field" data-field="operatingPeriod.yearsOfOperation" placeholder="e.g., 1985-2010, 2015-Present" data-autocomplete-category="operatingperiod" data-note-scope="facility" data-note-key="operatingPeriod.yearsOfOperation">
            </div>
            <div class="form-group">
                <label>Operational Notes</label>
                <div class="array-container" data-path="operatingPeriod.notes"></div>
            </div>
        </div>
    </div>
    <!-- Staff Section -->
    <div class="section" id="staff-section">
        <div class="section-header">
            <h2 class="section-title">Staff &amp; Links</h2>
            <span class="section-toggle">üîé</span>
        </div>
        <div class="section-content">
            <div class="form-group">
                <label>Administrator</label>
                <div class="array-container" data-path="staff.administrator"></div>
            </div>
            <div class="form-group">
                <label>Notable Staff</label>
                <div class="array-container" data-path="staff.notableStaff"></div>
            </div>
            <div class="form-group">
                <label>Profile Links</label>
                <div class="array-container" data-path="profileLinks"></div>
            </div>
        </div>
    </div>
    <!-- Facility Details Section -->
    <div class="section" id="facility-section">
        <div class="section-header">
            <h2 class="section-title">Facility Details</h2>
            <span class="section-toggle">üîé</span>
        </div>
        <div class="section-content">
            <div class="form-group">
                <label>Program Type</label>
                <input type="text" id="facility-type" placeholder="Type facility type..." class="facility-field input-form" data-field="facilityDetails.type" data-autocomplete-category="type" data-note-scope="facility" data-note-key="facilityDetails.type">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Capacity</label>
                    <input type="number" class="facility-field" data-field="facilityDetails.capacity" data-note-scope="facility" data-note-key="facilityDetails.capacity">
                </div>
                <div class="form-group">
                    <label>Current Census</label>
                    <input type="number" class="facility-field" data-field="facilityDetails.currentCensus" data-note-scope="facility" data-note-key="facilityDetails.currentCensus">
                </div>
            </div>
            <div class="form-row-3">
                <div class="form-group">
                    <label>Min Age</label>
                    <input type="number" class="facility-field" data-field="facilityDetails.ageRange.min" data-note-scope="facility" data-note-key="facilityDetails.ageRange.min">
                </div>
                <div class="form-group">
                    <label>Max Age</label>
                    <input type="number" class="facility-field" data-field="facilityDetails.ageRange.max" data-note-scope="facility" data-note-key="facilityDetails.ageRange.max">
                </div>
                <div class="form-group">
                    <label>Gender</label>
                    <input type="text" class="facility-field input-form" data-field="facilityDetails.gender" placeholder="Type gender (Male, Female, Co-ed)..." data-autocomplete-category="gender" data-note-scope="facility" data-note-key="facilityDetails.gender">
                </div>
            </div>
        </div>
    </div>
    <!-- Accreditations &amp; Memberships Section -->
    <div class="section" id="accreditations-section">
        <div class="section-header">
            <h2 class="section-title">Accreditations &amp; Memberships</h2>
            <span class="section-toggle">üîé</span>
        </div>
        <div class="section-content">
            <div class="form-group">
                <label>Current Accreditations</label>
                <div class="array-container" data-path="accreditations.current"></div>
            </div>
            <div class="form-group">
                <label>Past Accreditations</label>
                <div class="array-container" data-path="accreditations.past"></div>
            </div>
            <div class="form-group">
                <label>Professional Memberships</label>
                <div class="array-container" data-path="memberships"></div>
            </div>
            <div class="form-group">
                <label>Certifications</label>
                <div class="array-container" data-path="certifications"></div>
            </div>
            <div class="form-group">
                <label>Licensing Information</label>
                <div class="array-container" data-path="licensing"></div>
            </div>
        </div>
    </div>
    <!-- Resources &amp; Documentation Section -->
    <div class="section" id="resources-section">
        <div class="section-header">
            <h2 class="section-title">Available Resources &amp; Documentation</h2>
            <span class="section-toggle">üîé</span>
        </div>
        <div class="section-content">
            <h3 class="section-heading section-heading--spaced">Standard Resource Types</h3>
            <h4 class="section-subheading">News &amp; Media</h4>
            <div class="checkbox-group">
                <input type="checkbox" class="facility-checkbox" data-field="resources.hasNews" id="has-news">
                <label for="has-news">News Articles</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" class="facility-checkbox" data-field="resources.hasPressReleases" id="has-press">
                <label for="has-press">Press Releases</label>
            </div>
            <h4 class="section-subheading">Official Documentation</h4>
            <div class="checkbox-group">
                <input type="checkbox" class="facility-checkbox" data-field="resources.hasInspections" id="has-inspections">
                <label for="has-inspections">Inspection Reports</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" class="facility-checkbox" data-field="resources.hasStateReports" id="has-state-reports">
                <label for="has-state-reports">State Reports</label>
            </div>
            <h4 class="section-subheading">Legal &amp; Compliance</h4>
            <div class="checkbox-group">
                <input type="checkbox" class="facility-checkbox" data-field="resources.hasLawsuits" id="has-lawsuits">
                <label for="has-lawsuits">Lawsuits</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" class="facility-checkbox" data-field="resources.hasPoliceReports" id="has-police-reports">
                <label for="has-police-reports">Police Reports</label>
            </div>
            <h3 class="section-heading section-heading--spaced">Resource Notes</h3>
            <div class="form-group">
                <div class="array-container" data-path="resources.notes"></div>
            </div>
        </div>
    </div>
    <!-- General Notes Section -->
    <div class="section" id="notes-section">
        <div class="section-header">
            <h2 class="section-title">General Notes</h2>
            <span class="section-toggle">üîé</span>
        </div>
        <div class="section-content">
            <div class="form-group">
                <label>Facility Notes</label>
                <div class="array-container" data-path="notes"></div>
            </div>
        </div>
    </div>
    <!-- Project Management Section -->
    <div class="section expanded" id="project-section">
        <div class="section-header">
            <h2 class="section-title">üíæ Project Management</h2>
            <span class="section-toggle">üîé</span>
        </div>
        <div class="section-content">
            <div id="project-status" class="upload-status"></div>
            <div class="form-group">
                <label for="project-name">Project Name</label>
                <input type="text" id="project-name" placeholder="Enter project name to save..." class="input-form" data-note-scope="project" data-note-key="projectName" data-autocomplete-exempt="true">
            </div>
            <div class="form-group">
                <button class="btn btn--block" id="save-project-btn">üíæ Save to Cloud</button>
            </div>
            <div class="form-group">
                <button class="btn btn-secondary btn--block" id="new-project-btn">üìÑ New Project</button>
            </div>
            <div class="form-group">
                <button class="btn btn--block btn--success" id="submit-suggestion-btn" onclick="submitSuggestion()">üìÆ Submit Suggestion for Review</button>
            </div>
            <div id="upload-status" class="upload-status"></div>
            <div id="suggestion-status" class="upload-status"></div>
        </div>
    </div>
    <!-- JSON Output Section -->
    <div class="section" id="output-section">
        <div class="section-header">
            <h2 class="section-title">JSON Output</h2>
            <span class="section-toggle">üîé</span>
        </div>
        <div class="section-content">
            <div class="json-output">
                <div class="output-header">
                    <h3>Generated JSON</h3>
                    <div class="button-group">
                        <button class="copy-btn" id="copy-json-btn">Copy to Clipboard</button>
                        <button class="copy-btn" id="download-json-btn">Download JSON</button>
                    </div>
                </div>
                <pre id="json-display">{}</pre>
            </div>
            <div class="form-group form-group--spaced">
                <label for="file-upload">Import JSON File</label>
                <input type="file" id="file-upload" accept=".json">
            </div>
        </div>
    </div>
    <script>
        (function loadKidsOverProfitsAssets() {
            const isWordPress = typeof window.wp !== 'undefined' || Boolean(window.KOP_IS_WORDPRESS);

            if (isWordPress) {
                console.info('Kids Over Profits: WordPress detected, relying on enqueued assets.');
                return;
            }

            const defaultThemeBase = 'https://kidsoverprofits.org/themes/child';
            const legacyThemeBase = 'https://kidsoverprofits.org/wp-content/themes/child';
            const themeBasePattern = /(^\.\.\/(?:wp-content\/)?themes\/)|\/themes\//i;

            function cleanBase(value) {
                return typeof value === 'string' ? value.trim().replace(/\/+$/, '') : '';
            }

            const isValidThemeBase = typeof window.KOP_IS_VALID_THEME_BASE === 'function'
                ? window.KOP_IS_VALID_THEME_BASE
                : function (value) {
                    const normalized = cleanBase(value);
                    return Boolean(normalized && themeBasePattern.test(normalized));
                };

            const expandThemeBaseVariants = typeof window.KOP_EXPAND_THEME_BASE === 'function'
                ? window.KOP_EXPAND_THEME_BASE
                : function (base) {
                    const normalized = cleanBase(base);

                    if (!normalized) {
                        return [];
                    }

                    const variants = [normalized];
                    const wpSegment = '/wp-content/themes/';
                    const altSegment = '/themes/';

                    if (normalized.includes(wpSegment)) {
                        variants.push(normalized.replace(wpSegment, altSegment));
                    } else if (normalized.includes(altSegment)) {
                        variants.push(normalized.replace(altSegment, wpSegment));
                    }

                    const unique = new Set();

                    return variants
                        .map(cleanBase)
                        .filter((value) => {
                            if (!value || unique.has(value)) {
                                return false;
                            }

                            unique.add(value);
                            return true;
                        });
                };

            function deriveLocationThemeBase() {
                try {
                    if (window.location && window.location.origin) {
                        return cleanBase(window.location.origin + '/themes/child');
                    }
                } catch (error) {
                    console.warn('Kids Over Profits: unable to derive theme base from location.', error);
                }

                return '';
            }

            function collectUniqueBases(bases) {
                const seen = new Set();
                const results = [];

                bases.forEach((base) => {
                    const variants = expandThemeBaseVariants(base).concat(base);

                    variants.forEach((value) => {
                        const normalized = cleanBase(value);

                        if (!normalized || !isValidThemeBase(normalized) || seen.has(normalized)) {
                            return;
                        }

                        seen.add(normalized);
                        results.push(normalized);
                    });
                });

                return results;
            }

            function sortThemeBases(bases) {
                function rank(base) {
                    if (/\/themes\/child/i.test(base)) {
                        return 0;
                    }

                    if (/\/themes\//i.test(base)) {
                        return 1;
                    }

                    if (/\/wp-content\/themes\//i.test(base)) {
                        return 2;
                    }

                    if (/^\.\./.test(base)) {
                        return 3;
                    }

                    return 4;
                }

                return bases.slice().sort((a, b) => {
                    const diff = rank(a) - rank(b);

                    if (diff !== 0) {
                        return diff;
                    }

                    return a.length - b.length;
                });
            }

            const remoteBase = cleanBase(
                window.KOP_RESOLVED_THEME_BASE ||
                window.KOP_THEME_BASE ||
                window.KOP_DETECTED_THEME_BASE ||
                defaultThemeBase
            );
            const localBase = cleanBase(
                window.KOP_RESOLVED_LOCAL_BASE ||
                window.KOP_LOCAL_BASE ||
                window.KOP_DETECTED_THEME_BASE ||
                '../themes/child'
            );

            const knownBases = Array.isArray(window.KOP_THEME_BASES)
                ? window.KOP_THEME_BASES.map(cleanBase).filter(isValidThemeBase)
                : [];
            const candidateBases = knownBases.concat([
                remoteBase,
                localBase,
                defaultThemeBase,
                legacyThemeBase,
                deriveLocationThemeBase(),
                '../themes/child',
                '../wp-content/themes/child'
            ]);

            const assetBases = sortThemeBases(collectUniqueBases(candidateBases));

            const stylesheets = [
                'css/common.css',
                'css/layout.css',
                'css/forms.css',
                'css/tables.css',
                'css/modals.css',
                'css/admin.css'
            ];

            const scripts = [
                {
                    path: 'js/app-logic.js',
                    check: () => typeof window.initializeCollapsibleSections === 'function'
                },
                {
                    path: 'js/utilities.js',
                    type: 'module',
                    check: () => typeof window.utilities !== 'undefined'
                },
                {
                    path: 'js/facility-form.v3.js',
                    check: () => typeof window.updateAllUI === 'function'
                },
                {
                    path: 'js/data-form.js',
                    check: () => typeof window.submitSuggestion === 'function'
                }
            ];

            stylesheets.forEach((relativePath) => {
                loadStylesheet(relativePath);
            });

            scripts.reduce((promise, scriptConfig) => {
                return promise.then(() => ensureScript(scriptConfig));
            }, Promise.resolve()).catch((error) => {
                console.error('Kids Over Profits asset loader error:', error);
            });

            function normalizePath(path) {
                return path.replace(/^\//, '');
            }

            function buildUrl(base, relativePath) {
                if (/^https?:\/\//i.test(relativePath)) {
                    return relativePath;
                }

                return base + '/' + normalizePath(relativePath);
            }

            function loadStylesheet(relativePath) {
                const hrefs = assetBases.map((base) => buildUrl(base, relativePath));
                appendStylesheetFromList(hrefs, 0, relativePath);
            }

            function appendStylesheetFromList(hrefs, index, relativePath) {
                if (index >= hrefs.length) {
                    console.error('Kids Over Profits: all stylesheet sources failed to load.', { relativePath, hrefs });
                    return;
                }

                appendStylesheet(hrefs[index], () => {
                    const nextIndex = index + 1;
                    const nextHref = hrefs[nextIndex];

                    console.warn('Kids Over Profits: stylesheet failed, attempting fallback.', {
                        attemptedHref: hrefs[index],
                        fallbackHref: nextHref,
                        relativePath
                    });

                    appendStylesheetFromList(hrefs, nextIndex, relativePath);
                });
            }

            function appendStylesheet(href, onError) {
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = href;

                if (typeof onError === 'function') {
                    link.addEventListener('error', () => {
                        link.remove();
                        onError();
                    }, { once: true });
                }

                document.head.appendChild(link);
            }

            function ensureScript({ path, type = 'text/javascript', check }) {
                if (typeof check === 'function' && check()) {
                    return Promise.resolve();
                }

                const sources = assetBases.map((base) => buildUrl(base, path));
                return loadScriptFromList(sources, type, 0, path);
            }

            function loadScriptFromList(sources, type, index, relativePath) {
                if (index >= sources.length) {
                    return Promise.reject(new Error('All script sources failed for ' + relativePath));
                }

                const src = sources[index];

                return loadScript(src, type).catch((error) => {
                    const nextIndex = index + 1;
                    const nextSrc = sources[nextIndex];

                    console.warn('Kids Over Profits: script failed to load, attempting fallback.', {
                        attemptedSrc: src,
                        fallbackSrc: nextSrc,
                        relativePath,
                        error
                    });

                    return loadScriptFromList(sources, type, nextIndex, relativePath);
                });
            }

            function loadScript(src, type) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');

                    if (type === 'module') {
                        script.type = 'module';
                    }

                    script.src = src;
                    script.defer = false;
                    script.onload = () => resolve();
                    script.onerror = () => reject(new Error('Failed to load script: ' + src));

                    document.body.appendChild(script);
                });
            }
        })();
    </script>
</div>

