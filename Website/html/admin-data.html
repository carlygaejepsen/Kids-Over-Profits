<div class="container">
    <div class="admin-header">
        <h1>Admin: Master Facility Data Entry</h1>
        <p>All changes auto-save to the cloud master database.</p>
    </div>
    <div class="admin-warning admin-warning--danger">
        ‚ö†Ô∏è <strong>ADMIN/MASTER MODE:</strong> Data entered here is saved directly to the master database. Changes are immediate and permanent.
    </div>
    <!-- Category Navigation -->
    <div class="category-navigation" id="category-navigation">
        <div class="flex-center mb-20">
            <div class="category-tabs">
                <button class="category-tab active" id="facilities-tab">
                    üè¢ Companies
                </button>
                <button class="category-tab" id="states-tab">
                    üåç Locations
                </button>
            </div>
        </div>
        <!-- Companies Content -->
        <div id="companies-content" class="category-content">
            <div class="content-header">
                <h3>Select an Operator/Company</h3>
                <p>All projects load from cloud storage</p>
            </div>
            <div class="items-list items-container" id="saved-projects-list">
                <div class="text-muted italic">Loading from cloud...</div>
            </div>
        </div>
        <!-- States Content -->
        <div id="states-content" class="category-content d-none">
            <div class="content-header">
                <h3>Location Projects</h3>
                <p>All projects load from cloud storage</p>
            </div>
            <div class="items-list items-container" id="locations-list">
                <div class="text-muted italic">Loading from cloud...</div>
            </div>
        </div>
    </div>
    <!-- Facility Table of Contents -->
    <div class="facility-toc" id="facility-toc">
        <div class="toc-header">
            <h2 class="toc-title">Facilities Overview</h2>
            <button class="toc-toggle" id="toc-toggle-btn">üîé</button>
        </div>
        <div class="toc-content">
            <div class="toc-stats" id="toc-stats">Total: 1 facility</div>
            <div class="facility-list" id="facility-list">
                <!-- Facility items will be populated here -->
            </div>
            <div class="mt-15 d-flex gap-10 flex-center">
                <button class="btn" id="add-facility-main-btn">Add New Facility</button>
                <button class="btn" id="sort-facilities-btn">Sort Alphabetically</button>
            </div>
        </div>
    </div>
    <!-- Facility Navigation -->
    <div class="facility-controls">
        <div class="facility-header">
            <div class="d-flex align-items-center gap-15">
                <strong>Current Facility: <span id="facility-counter">1 of 1</span></strong>
                <span id="current-facility-name" class="text-muted fw-normal"></span>
                <div class="d-flex gap-5">
                    <button class="btn btn--compact d-none" id="prev-facility-btn">‚¨ÖÔ∏è Previous</button>
                    <button class="btn btn--compact d-none" id="next-facility-btn">Next ‚û°Ô∏è</button>
                </div>
            </div>
            <div class="controls">
                <button class="btn" id="add-facility-btn">Add Facility</button>
                <button class="btn d-none" id="remove-facility-btn">Remove Current</button>
                <button class="btn" id="clone-facility-btn">Clone Facility</button>
            </div>
        </div>
    </div>
    <!-- Operator Information Section -->
    <div class="section expanded" id="operator-section">
        <div class="section-header">
            <h2 class="section-title">Operator Information</h2>
            <span class="section-toggle">üîé</span>
        </div>
        <div class="section-content">
            <div class="form-row">
                <div class="form-group">
                    <label for="operator-name">Operator Name</label>
                    <input type="text" id="operator-name" placeholder="Type operator name..." class="input-form">
                </div>
                <div class="form-group">
                    <label for="operator-current-name">Current Name</label>
                    <input type="text" id="operator-current-name" placeholder="Type current operator name..." class="input-form">
                </div>
            </div>
            <div class="form-group">
                <label>Other Names</label>
                <div class="array-container" data-path="operator.otherNames"></div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="operator-location">Primary Location</label>
                    <input type="text" id="operator-location" placeholder="e.g., Waynesboro, TN">
                </div>
                <div class="form-group">
                    <label for="operator-headquarters">Headquarters</label>
                    <input type="text" id="operator-headquarters" placeholder="e.g., Nashville, TN">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="operator-founded">Founded</label>
                    <input type="text" id="operator-founded" placeholder="e.g., 1985">
                </div>
                <div class="form-group">
                    <label for="operator-period">Operating Period</label>
                    <input type="text" id="operator-period" placeholder="e.g., 1985-Present">
                </div>
            </div>
            <div class="form-group">
                <label for="operator-status">Status</label>
                <input type="text" id="operator-status" placeholder="Type status (Active, Acquired, Merged, Defunct, etc.)..." class="input-form">
            </div>
            <div class="form-group">
                <label>Parent Companies</label>
                <div class="array-container" data-path="operator.parentCompanies"></div>
            </div>
            <div class="form-group">
                <label>Websites</label>
                <div class="array-container" data-path="operator.websites"></div>
            </div>
            <h3 class="section-heading">Key Staff</h3>
            <div class="form-group">
                <label for="operator-ceo">CEO/President</label>
                <input type="text" id="operator-ceo" placeholder="e.g., John Smith">
            </div>
            <div class="form-group">
                <label>Founders</label>
                <div class="array-container" data-path="operator.keyStaff.founders"></div>
            </div>
            <div class="form-group">
                <label>Key Executives</label>
                <div class="array-container" data-path="operator.keyStaff.keyExecutives"></div>
            </div>
            <div class="form-group">
                <label>Investors</label>
                <div class="array-container" data-path="operator.investors"></div>
            </div>
            <div class="form-group">
                <label>Operator Notes</label>
                <div class="array-container" data-path="operator.notes"></div>
            </div>
        </div>
    </div>
    <!-- Identification Section -->
    <div class="section" id="identification-section">
        <div class="section-header">
            <h2 class="section-title">Identification &amp; Names</h2>
            <span class="section-toggle">üîé</span>
        </div>
        <div class="section-content">
            <div class="form-row">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="facility-name" placeholder="Type facility name..." class="input-form">
                </div>
                <div class="form-group">
                    <label>Current Name</label>
                    <input type="text" class="facility-field" data-field="identification.currentName">
                </div>
            </div>
            <div class="form-group">
                <label>Current Operator</label>
                <input type="text" class="facility-field" data-field="identification.currentOperator">
            </div>
            <div class="form-group">
                <label>Other Names</label>
                <div class="array-container" data-path="identification.otherNames"></div>
            </div>
        </div>
    </div>
    <!-- Location Section -->
    <div class="section" id="location-section">
        <div class="section-header">
            <h2 class="section-title">Location &amp; Address</h2>
            <span class="section-toggle">üîé</span>
        </div>
        <div class="section-content">
            <div class="form-group">
                <label>Location</label>
                <input type="text" class="facility-field" data-field="location">
            </div>
            <div class="form-group">
                <label>Address</label>
                <textarea class="facility-field" data-field="address" rows="3"></textarea>
            </div>
        </div>
    </div>
    <!-- Operations Section -->
    <div class="section" id="operations-section">
        <div class="section-header">
            <h2 class="section-title">Facility Operations</h2>
            <span class="section-toggle">üîé</span>
        </div>
        <div class="section-content">
            <div class="form-group">
                <label>Other Operators</label>
                <div class="array-container" data-path="otherOperators"></div>
            </div>
            <h3 class="section-heading section-heading--spaced">Facility Operating Dates</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Facility Opened (Year)</label>
                    <input type="number" class="facility-field" data-field="operatingPeriod.startYear" placeholder="e.g., 1985">
                </div>
                <div class="form-group">
                    <label>Facility Closed (Year)</label>
                    <input type="number" class="facility-field" data-field="operatingPeriod.endYear" placeholder="Leave blank if still open">
                </div>
            </div>
            <div class="form-group">
                <label>Current Status</label>
                <input type="text" class="facility-field" data-field="operatingPeriod.status" placeholder="Type status (Open, Closed, Transferred, etc.)..." class="input-form">
            </div>
            <div class="form-group">
                <label>Years of Operation</label>
                <input type="text" class="facility-field" data-field="operatingPeriod.yearsOfOperation" placeholder="e.g., 1985-2010, 2015-Present">
            </div>
            <div class="form-group">
                <label>Operational Notes</label>
                <div class="array-container" data-path="operatingPeriod.notes"></div>
            </div>
        </div>
    </div>
    <!-- Staff Section -->
    <div class="section" id="staff-section">
        <div class="section-header">
            <h2 class="section-title">Staff &amp; Links</h2>
            <span class="section-toggle">üîé</span>
        </div>
        <div class="section-content">
            <div class="form-group">
                <label>Administrator</label>
                <div class="array-container" data-path="staff.administrator"></div>
            </div>
            <div class="form-group">
                <label>Notable Staff</label>
                <div class="array-container" data-path="staff.notableStaff"></div>
            </div>
            <div class="form-group">
                <label>Profile Links</label>
                <div class="array-container" data-path="profileLinks"></div>
            </div>
        </div>
    </div>
    <!-- Facility Details Section -->
    <div class="section" id="facility-section">
        <div class="section-header">
            <h2 class="section-title">Facility Details</h2>
            <span class="section-toggle">üîé</span>
        </div>
        <div class="section-content">
            <div class="form-group">
                <label>Program Type</label>
                <input type="text" id="facility-type" placeholder="Type facility type..." class="input-form">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Capacity</label>
                    <input type="number" class="facility-field" data-field="facilityDetails.capacity">
                </div>
                <div class="form-group">
                    <label>Current Census</label>
                    <input type="number" class="facility-field" data-field="facilityDetails.currentCensus">
                </div>
            </div>
            <div class="form-row-3">
                <div class="form-group">
                    <label>Min Age</label>
                    <input type="number" class="facility-field" data-field="facilityDetails.ageRange.min">
                </div>
                <div class="form-group">
                    <label>Max Age</label>
                    <input type="number" class="facility-field" data-field="facilityDetails.ageRange.max">
                </div>
                <div class="form-group">
                    <label>Gender</label>
                    <input type="text" class="facility-field" data-field="facilityDetails.gender" placeholder="Type gender (Male, Female, Co-ed)..." class="input-form">
                </div>
            </div>
        </div>
    </div>
    <!-- Accreditations &amp; Memberships Section -->
    <div class="section" id="accreditations-section">
        <div class="section-header">
            <h2 class="section-title">Accreditations &amp; Memberships</h2>
            <span class="section-toggle">üîé</span>
        </div>
        <div class="section-content">
            <div class="form-group">
                <label>Current Accreditations</label>
                <div class="array-container" data-path="accreditations.current"></div>
            </div>
            <div class="form-group">
                <label>Past Accreditations</label>
                <div class="array-container" data-path="accreditations.past"></div>
            </div>
            <div class="form-group">
                <label>Professional Memberships</label>
                <div class="array-container" data-path="memberships"></div>
            </div>
            <div class="form-group">
                <label>Certifications</label>
                <div class="array-container" data-path="certifications"></div>
            </div>
            <div class="form-group">
                <label>Licensing Information</label>
                <div class="array-container" data-path="licensing"></div>
            </div>
        </div>
    </div>
    <!-- Resources &amp; Documentation Section -->
    <div class="section" id="resources-section">
        <div class="section-header">
            <h2 class="section-title">Available Resources &amp; Documentation</h2>
            <span class="section-toggle">üîé</span>
        </div>
        <div class="section-content">
            <h3 class="section-heading section-heading--spaced">Standard Resource Types</h3>
            <h4 class="section-subheading">News &amp; Media</h4>
            <div class="checkbox-group">
                <input type="checkbox" class="facility-checkbox" data-field="resources.hasNews" id="has-news">
                <label for="has-news">News Articles</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" class="facility-checkbox" data-field="resources.hasPressReleases" id="has-press">
                <label for="has-press">Press Releases</label>
            </div>
            <h4 class="section-subheading">Official Documentation</h4>
            <div class="checkbox-group">
                <input type="checkbox" class="facility-checkbox" data-field="resources.hasInspections" id="has-inspections">
                <label for="has-inspections">Inspection Reports</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" class="facility-checkbox" data-field="resources.hasStateReports" id="has-state-reports">
                <label for="has-state-reports">State Reports</label>
            </div>
            <h4 class="section-subheading">Legal &amp; Compliance</h4>
            <div class="checkbox-group">
                <input type="checkbox" class="facility-checkbox" data-field="resources.hasLawsuits" id="has-lawsuits">
                <label for="has-lawsuits">Lawsuits</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" class="facility-checkbox" data-field="resources.hasPoliceReports" id="has-police-reports">
                <label for="has-police-reports">Police Reports</label>
            </div>
            <h3 class="section-heading section-heading--spaced">Resource Notes</h3>
            <div class="form-group">
                <div class="array-container" data-path="resources.notes"></div>
            </div>
        </div>
    </div>
    <!-- General Notes Section -->
    <div class="section" id="notes-section">
        <div class="section-header">
            <h2 class="section-title">General Notes</h2>
            <span class="section-toggle">üîé</span>
        </div>
        <div class="section-content">
            <div class="form-group">
                <label>Facility Notes</label>
                <div class="array-container" data-path="notes"></div>
            </div>
        </div>
    </div>
    <!-- Project Management Section -->
    <div class="section expanded" id="project-section">
        <div class="section-header">
            <h2 class="section-title">üíæ Project Management</h2>
            <span class="section-toggle">üîé</span>
        </div>
        <div class="section-content">
            <div id="project-status" class="upload-status"></div>
            <div class="form-group">
                <label for="project-name">Project Name</label>
                <input type="text" id="project-name" placeholder="Enter project name to save..." class="input-form">
            </div>
            <div class="form-group">
                <button class="btn btn--block" id="save-project-btn">üíæ Save to Cloud</button>
            </div>
            <div class="form-group">
                <button class="btn btn-secondary btn--block" id="new-project-btn">üìÑ New Project</button>
            </div>
            <div id="upload-status" class="upload-status"></div>
        </div>
    </div>
    <!-- JSON Output Section -->
    <div class="section expanded" id="output-section">
        <div class="section-header">
            <h2 class="section-title">JSON Output</h2>
            <span class="section-toggle">üîé</span>
        </div>
        <div class="section-content">
            <div class="json-output">
                <div class="output-header">
                    <h3>Generated JSON</h3>
                    <div class="button-group">
                        <button class="copy-btn" id="copy-json-btn">Copy to Clipboard</button>
                        <button class="copy-btn" id="download-json-btn">Download JSON</button>
                    </div>
                </div>
                <pre id="json-display">{}</pre>
            </div>
            <div class="form-group form-group--spaced">
                <label for="file-upload">Import JSON File</label>
                <input type="file" id="file-upload" accept=".json">
            </div>
        </div>
    </div>
    <script>
        (function loadKidsOverProfitsAdminAssets() {
            const isWordPress = typeof window.wp !== 'undefined';

            if (isWordPress) {
                console.info('Kids Over Profits: WordPress detected, relying on enqueued assets.');
                return;
            }

            const remoteBase = (window.KOP_THEME_BASE || 'https://kidsoverprofits.org/wp-content/themes/child').replace(/\/$/, '');
            const localBase = (window.KOP_LOCAL_BASE || '..').replace(/\/$/, '');

            const stylesheets = [
                'css/common.css',
                'css/layout.css',
                'css/forms.css',
                'css/tables.css',
                'css/modals.css',
                'css/admin.css'
            ];

            const scripts = [
                {
                    path: 'js/app-logic.js',
                    check: () => typeof window.initializeCollapsibleSections === 'function'
                },
                {
                    path: 'js/utilities.js',
                    type: 'module',
                    check: () => typeof window.utilities !== 'undefined'
                },
                {
                    path: 'js/facility-form.v3.js',
                    check: () => typeof window.updateAllUI === 'function'
                },
                {
                    path: 'js/admin-data.js',
                    check: () => typeof window.handleExportAll === 'function'
                }
            ];

            stylesheets.forEach((relativePath) => {
                loadStylesheet(relativePath);
            });

            scripts.reduce((promise, scriptConfig) => {
                return promise.then(() => ensureScript(scriptConfig));
            }, Promise.resolve()).catch((error) => {
                console.error('Kids Over Profits admin asset loader error:', error);
            });

            function normalizePath(path) {
                return path.replace(/^\//, '');
            }

            function buildUrl(base, relativePath) {
                if (/^https?:\/\//i.test(relativePath)) {
                    return relativePath;
                }

                return base + '/' + normalizePath(relativePath);
            }

            function loadStylesheet(relativePath) {
                const primaryHref = buildUrl(remoteBase, relativePath);
                const fallbackHref = buildUrl(localBase, relativePath);

                appendStylesheet(primaryHref, () => {
                    console.warn('Kids Over Profits: primary stylesheet failed, falling back to local copy.', {
                        primaryHref,
                        fallbackHref
                    });
                    appendStylesheet(fallbackHref);
                });
            }

            function appendStylesheet(href, onError) {
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = href;

                if (typeof onError === 'function') {
                    link.addEventListener('error', () => {
                        link.remove();
                        onError();
                    }, { once: true });
                }

                document.head.appendChild(link);
            }

            function ensureScript({ path, type = 'text/javascript', check }) {
                if (typeof check === 'function' && check()) {
                    return Promise.resolve();
                }

                const primarySrc = buildUrl(remoteBase, path);
                const fallbackSrc = buildUrl(localBase, path);

                return loadScript(primarySrc, type).catch(() => {
                    console.warn('Kids Over Profits: primary script failed, falling back to local copy.', {
                        primarySrc,
                        fallbackSrc
                    });
                    return loadScript(fallbackSrc, type);
                });
            }

            function loadScript(src, type) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');

                    if (type === 'module') {
                        script.type = 'module';
                    }

                    script.src = src;
                    script.defer = false;
                    script.onload = () => resolve();
                    script.onerror = () => reject(new Error('Failed to load script: ' + src));

                    document.body.appendChild(script);
                });
            }
        })();
    </script>
</div>

